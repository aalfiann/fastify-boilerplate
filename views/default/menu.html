<!DOCTYPE html>
<html lang="en" class="has-aside-left has-aside-mobile-transition has-navbar-fixed-top has-aside-expanded">
<head>
  <%~ includeFile('partial-head-main.html', it) %>
  <title>Menu - <%=it.siteName%></title>
  <%~ includeFile('partial-head-meta.html', it) %>
</head>
<body>
  <!-- Menu Navbar -->
  <%~ includeFile('partial-menu-navbar.html', it) %>
  <!-- Menu Aside -->
  <%~ includeFile('partial-menu-aside.html', it) %>
  <section class="section is-title-bar">
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <ul>
            <li><a href="<%=it.baseUrl%>" class="has-text-dark">Home</a></li>
            <li>Menu</li>
          </ul>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item">
          <div class="buttons is-right">
            <a href="https://admin-one-html.justboil.me/" target="_blank" class="button is-primary">
              <span class="icon"><i class="mdi mdi-credit-card-outline"></i></span>
              <span>Premium Demo</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="hero is-hero-bar">
    <div class="hero-body">
      <div class="level">
        <div class="level-left">
          <div class="level-item"><h1 class="title">
            Menu
          </h1></div>
        </div>
        <div class="level-right" style="display: none;">
          <div class="level-item"></div>
        </div>
      </div>
    </div>
  </section>
  <section class="section is-main-section">
    <div class="card has-table has-mobile-sort-spaced">
      <header class="card-header">
        <p class="card-header-title">
          <span class="icon"><i class="mdi mdi-format-list-bulleted"></i></span>
          Menu List
        </p>
        <div class="card-header-icon field">
          <p class="control has-icons-right">
            <input id="search" type="text" class="input" placeholder="Search...">
            <span class="icon is-small is-right">
              <i class="mdi mdi-magnify"></i>
            </span>
          </p>
        </div>
      </header>
      <div class="card-content">
        <div id="datatable"></div>
      </div>
    </div>
  </section>
  <!-- Footer -->
  <%~ includeFile('partial-footer.html', it) %>
  <!-- Inline JS -->
  <%~ includeFile('partial-js.html', it) %>
  <!-- Datatable Pagination and Search -->
  <script type="text/javascript" src="<%=it.baseAssetsUrl%>/assets/js/chunk-handler/chunkhandler.min.js"></script>
  <script type="text/javascript" src="<%=it.baseAssetsUrl%>/assets/js/fly-json-odm/flyjson.min.js"></script>
  <script>
    var datatable;
    var dt = [];
    var pageNow = 1;
    var itemPerPage = 2;
    var totalPage = 1;
    getToken('<%=it.baseUrl%>', function(token) {
      // If have no token, redirect to login
      if(!token) return location = '<%=it.baseUrl%>'+'/login';
      
      getMenu('<%=it.baseUrl%>', token, function(err,valid) {
        // If user have no acces to this url menu link, redirect to dashboard
        if (!err && !valid) return location.href = '/dashboard';
      });
      
      loadData('<%=it.baseUrl%>',token, function(err,data) {
        if(!err) searchData('',pageNow,itemPerPage);
      });

      datatable = new Reef('#datatable', {
        data: {
          table : [],
          message: '',
          pageNow: pageNow,
          totalPage: totalPage
        },
        template: function(props) {
          if(props.table.length > 0) {
            return `<div class="b-table has-pagination">
              <div class="table-wrapper has-mobile-cards">
                <table class="table is-fullwidth is-striped is-hoverable is-sortable is-fullwidth">
                  <thead>
                  <tr>
                    <th>No</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Scope</th>
                    <th>Url</th>
                    <th>Position</th>
                    <th>Created</th>
                    <th>Updated</th>
                  </tr>
                  </thead>
                  <tbody>
                  ${props.table.map(function(item, index) {
                    var num = (index+1);
                    return `<tr>
                      <td data-label="No">${num+((props.pageNow-1)*itemPerPage)}</td>
                      <td data-label="ID">${item.id}</td>
                      <td data-label="Name">${item.name}</td>
                      <td data-label="Type">${item.type}</td>
                      <td data-label="Scope">${item.scope}</td>
                      <td data-label="Url">${item.url}</td>
                      <td data-label="Position">${item.position}</td>
                      <td data-label="Created">${item.created_at}</td>
                      <td data-label="Created">${item.updated_at}</td>
                      <td class="is-actions-cell">
                        <div class="buttons is-right">
                          <button class="button is-small is-primary" type="button" title="Edit Parent Menu">
                            <span class="icon"><i class="mdi mdi-pencil-outline"></i></span>
                          </button>
                          <button class="button is-small is-info" type="button" title="Edit Child Menu">
                            <span class="icon"><i class="mdi mdi-playlist-edit"></i></span>
                          </button>
                          <button class="button is-small is-danger jb-modal" type="button" title="Delete Menu">
                            <span class="icon"><i class="mdi mdi-trash-can"></i></span>
                          </button>
                        </div>
                      </td>
                    </tr>`;
                  }).join('')}
                  </tbody>
                </table>
              </div>
              <div class="notification">
                <div class="level">
                  <div class="level-left">
                    <div class="level-item">
                      <div class="buttons has-addons">
                        <button type="button" class="button" onclick="prevPage()">Prev</button>
                        <button type="button" class="button" onclick="nextPage()">Next</button>
                      </div>
                    </div>
                  </div>
                  <div class="level-right">
                    <div class="level-item">
                      <small>Page ${props.pageNow} of ${props.totalPage}</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;
          } else {
            return `<article class="message is-danger">
                <div class="message-body">
                  ${(props.message) ? props.message : 'Something went wrong!'}
                </div>
              </article>`;
          }
        }
      });
      datatable.render();
    });

    function loadData(baseUrl,token,_cb) {
      if(dt.length === 0) {
        ajax({
          headers: {
            'x-token': token
          }
        })
        .get(baseUrl+'/api/menu/parent/list')
        .then(function(response, xhr) {
          if(response.statusCode === 200) {
            dt = response.data;
            if(_cb && typeof _cb === "function") {
                _cb(null,dt);
            }
          }
          return dt;
        })
        .catch(function(response, xhr) {
          dt = [];
          if(_cb && typeof _cb === "function") {
              _cb(xhr.responseText,null);
          } else {
              return dt;
          }
        })
      }
      return dt;
    }

    function searchData(value,pageNow,itemPerPage) {
      if(dt.length > 0) {
        var nosql = new FlyJson();
        var ch = new ChunkHandler();
        var result = nosql.set(dt)
        .begin()
        .where('id', 'like', value, false)
        .or()
        .where('name', 'like', value, false)
        .or()
        .where('type', 'like', value, false)
        .or()
        .where('scope', 'like', value, false)
        .end()
        .distinct()
        .orderBy('position')
        .exec();
        var retotalPage = ch.make(result,itemPerPage).length;
        var redata = nosql.set(result).paginate(pageNow,itemPerPage).exec();
        if (redata.length > 0) {
          datatable.data.table = redata;
          datatable.data.pageNow = pageNow;
          datatable.data.totalPage = retotalPage;
          totalPage = retotalPage;
        } else {
          datatable.data.table = [];
          datatable.data.pageNow = 0;
          datatable.data.totalPage = 0;
          totalPage = 0;
          datatable.data.message = 'Records not found!';
        }
      } else {
        datatable.data.message = 'Records not found!';
      }
    }

    function nextPage() {
      if(pageNow < totalPage) {
        pageNow = pageNow + 1;
        searchData(Dom.id('search').value,pageNow,itemPerPage);
      }
    }

    function prevPage() {
      if(pageNow > 1) {
        pageNow = pageNow - 1;
        searchData(Dom.id('search').value,pageNow,itemPerPage);
      }
    }

    Dom.id('search').addEventListener('keyup', function(e) {
      if (e.keyCode === 13) {
        searchData(this.value, 1, itemPerPage);
      }
    })
  </script>
</body>
</html>
